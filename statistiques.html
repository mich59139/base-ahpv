<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“ˆ Statistiques des publications AHPV</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f9f6f0;
      padding: 2rem;
      color: #333;
    }
    h1 {
      font-size: 1.8rem;
    }
    .filters {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>ðŸ“ˆ Statistiques interactives des publications AHPV</h1>

  <div class="filters">
    <label for="champ">Champ :</label>
    <select id="champ">
      <option value="Auteurs">Auteurs</option>
      <option value="Villes">Villes</option>
      <option value="Themes">ThÃ¨mes</option>
      <option value="Epoque">Ã‰poque</option>
      <option value="Siecle">SiÃ¨cle</option>
    </select>
    <input type="text" id="valeur" placeholder="Rechercher...">
    <button onclick="filtrer()">Afficher</button>
  </div>

  <table id="filteredTable" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const visibleColumns = ['Numero', 'Titre', 'Pages', 'Auteurs', 'Villes', 'Themes', 'Epoque', 'Siecle'];
    const hiddenColumns = ['Auteurs_Liste', 'Villes_Liste', 'Themes_Liste'];

    let allData = [];

    function initTable(data) {
      const headers = Object.keys(data[0]);
      const theadHTML = '<tr>' + headers.map(h => '<th>' + h + '</th>').join('') + '</tr>';
      const tbodyHTML = data.map(row => {
        return '<tr>' + headers.map(h => '<td>' + (row[h] || '') + '</td>').join('') + '</tr>';
      }).join('');
      $('#filteredTable thead').html(theadHTML);
      $('#filteredTable tbody').html(tbodyHTML);

      const colDefs = headers.map((h, i) => {
        return {
          targets: i,
          visible: visibleColumns.includes(h)
        };
      });

      if ($.fn.DataTable.isDataTable('#filteredTable')) {
        $('#filteredTable').DataTable().destroy();
      }

      $('#filteredTable').DataTable({
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel'],
        columnDefs: colDefs,
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
        }
      });
    }

    function filtrer() {
      const champ = document.getElementById('champ').value;
      const valeur = document.getElementById('valeur').value.toLowerCase();
      const filtered = allData.filter(row => 
        row[champ] && row[champ].toLowerCase().includes(valeur)
      );
      initTable(filtered);
    }

    fetch('base_ahpv_enriched_simplified.csv')
      .then(response => response.text())
      .then(csv => {
        const [headerLine, ...lines] = csv.trim().split('\n');
        const headers = headerLine.split(',');
        allData = lines.map(line => {
          const values = line.split(',');
          return headers.reduce((obj, h, i) => {
            obj[h] = values[i] || "";
            return obj;
          }, {});
        });
        initTable(allData);
      });
  </script>
</body>
</html>
