
<!-- Bouton pour ouvrir les statistiques -->
<div style="text-align: center; margin-top: 2em;">
  <button id="openStats" style="background:#d4b483;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;">
    ðŸ“Š Voir les statistiques
  </button>
</div>

<!-- FenÃªtre modale -->
<div id="statsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fffef9; padding:20px; border-radius:8px; max-width:800px; width:90%; position:relative;">
    <span id="closeStats" style="position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer;">&times;</span>
    <h2 style="text-align:center;">Statistiques du catalogue</h2>
    <canvas id="themeChart" style="margin-top:20px;"></canvas>
    <canvas id="centuryChart" style="margin-top:40px;"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
document.getElementById("openStats").onclick = () => {
  document.getElementById("statsModal").style.display = "flex";
};
document.getElementById("closeStats").onclick = () => {
  document.getElementById("statsModal").style.display = "none";
};

// Charger et afficher les stats uniquement au premier affichage
let statsLoaded = false;
document.getElementById("openStats").addEventListener("click", function() {
  if (statsLoaded) return;
  statsLoaded = true;

  fetch("base_ahpv_enriched_simplified.csv")
    .then(response => response.text())
    .then(csv => {
      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;

          const themeCount = {};
          data.forEach(row => {
            const themes = row["Themes"]?.split(",") || [];
            themes.forEach(t => {
              const clean = t.trim();
              if (clean) themeCount[clean] = (themeCount[clean] || 0) + 1;
            });
          });
          const sortedThemes = Object.entries(themeCount).sort((a,b) => b[1] - a[1]).slice(0,10);
          const themeLabels = sortedThemes.map(e => e[0]);
          const themeValues = sortedThemes.map(e => e[1]);

          new Chart(document.getElementById("themeChart"), {
            type: "bar",
            data: {
              labels: themeLabels,
              datasets: [{
                label: "Articles par thÃ¨me",
                data: themeValues,
                backgroundColor: "#b8946b"
              }]
            },
            options: {
              plugins: {
                legend: { display: false }
              },
              responsive: true,
              scales: {
                y: { beginAtZero: true }
              }
            }
          });

          const centuryCount = {};
          data.forEach(row => {
            const siecle = row["Siecle"]?.trim();
            if (siecle) centuryCount[siecle] = (centuryCount[siecle] || 0) + 1;
          });
          const sortedCenturies = Object.entries(centuryCount).sort((a,b) => +a[0] - +b[0]);
          const centuryLabels = sortedCenturies.map(e => "SiÃ¨cle " + e[0]);
          const centuryValues = sortedCenturies.map(e => e[1]);

          new Chart(document.getElementById("centuryChart"), {
            type: "bar",
            data: {
              labels: centuryLabels,
              datasets: [{
                label: "Articles par siÃ¨cle",
                data: centuryValues,
                backgroundColor: "#6c91a1"
              }]
            },
            options: {
              plugins: {
                legend: { display: false }
              },
              responsive: true,
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      });
    });
});
</script>
